<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Camera Voxel</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body {
  margin:0;
  background:black;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}

#view {
  width:320px;
  height:320px;
  image-rendering: pixelated;
  border:2px solid white;
}

button {
  margin-top:10px;
  padding:6px 12px;
}
</style>
</head>
<body>

<canvas id="view" width="96" height="96"></canvas>
<div id="status">üòê</div>
<button id="modeBtn">Modo: COLOR</button>

<video id="video" autoplay muted playsinline hidden></video>
<canvas id="send" width="96" height="96" hidden></canvas>

<script>
const video = document.getElementById("video")
const view = document.getElementById("view")
const vctx = view.getContext("2d")
const send = document.getElementById("send")
const sctx = send.getContext("2d")
const status = document.getElementById("status")
const modeBtn = document.getElementById("modeBtn")

let smiling = false
let mode = "color"

modeBtn.onclick = () => {
  mode = mode === "color" ? "bw" : "color"
  modeBtn.innerText = "Modo: " + mode.toUpperCase()
}

const faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
})

faceMesh.setOptions({ maxNumFaces:1 })

faceMesh.onResults(r => {
  smiling = false
  if (r.multiFaceLandmarks?.[0]) {
    const lm = r.multiFaceLandmarks[0]
    const w = Math.abs(lm[61].x - lm[291].x)
    const o = Math.abs(lm[13].y - lm[14].y)
    if (o > w * 0.25) smiling = true
  }
  status.innerText = smiling ? "üòÑ SORRINDO" : "üòê"
})

navigator.mediaDevices.getUserMedia({ video:true }).then(stream => {
  video.srcObject = stream
  const cam = new Camera(video,{
    onFrame: async ()=> await faceMesh.send({image:video})
  })
  cam.start()
})

setInterval(()=>{
  vctx.drawImage(video,0,0,96,96)
  sctx.drawImage(video,0,0,96,96)

  const img = send.toDataURL("image/jpeg",0.5).split(",")[1]

  fetch("/camera",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      image: img,
      smiling: smiling,
      mode: mode
    })
  })
},50)
</script>

</body>
</html>
